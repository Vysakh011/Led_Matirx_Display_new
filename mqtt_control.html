<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>MQTT Control & Sensor Data</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#6a11cb" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icon-192.png" />
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
/* [ALL YOUR ORIGINAL STYLES — UNCHANGED] /
body {
font-family: Arial, sans-serif;
background: linear-gradient(to right, #6a11cb, #2575fc);
color: white;
text-align: center;
margin: 0;
padding: 0;
-webkit-tap-highlight-color: transparent;
}
.container {
background: white;
color: black;
max-width: 90%;
width: 400px;
margin: 30px auto;
padding: 30px;
border-radius: 10px;
box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
}
h1 {
font-size: 22px;
margin-bottom: 10px;
}
label {
font-weight: bold;
}
#message {
width: calc(100% - 20px);
padding: 10px;
margin-top: 10px;
border: 2px solid #ccc;
border-radius: 5px;
text-align: center;
font-size: 16px;
}
button {
width: 100%;
padding: 10px;
margin-top: 10px;
border: none;
cursor: pointer;
border-radius: 5px;
font-size: 16px;
}
#sendButton {
background: #3b82f6;
color: white;
}
#sendButton:hover {
background: #2563eb;
}
#clearButton {
background: #f44336;
color: white;
}
#clearButton:hover {
background: #d32f2f;
}
table {
width: 100%;
margin-top: 20px;
border-collapse: collapse;
}
table, th, td {
border: 1px solid #ddd;
}
th {
background: #3b82f6;
color: white;
padding: 10px;
}
td {
padding: 10px;
text-align: center;
background: #f9f9f9;
}
.logout-btn {
background: red;
color: white;
position: fixed;
bottom: 20px;
right: 20px;
font-size: 14px;
padding: 8px 15px;
border-radius: 5px;
border: none;
cursor: pointer;
width: auto;
display: inline-block;
}
.logout-btn:hover {
background: darkred;
}
/ *** MODIFIED: Reverted back to the message history list view *** */
#messageHistory {
margin-top: 20px;
max-height: 200px;
overflow-y: auto;
border: 1px solid #ddd;
border-radius: 5px;
padding: 10px;
background: #f9f9f9;
color: black;
}
#messageHistory h3 {
margin-top: 0;
color: #3b82f6;
}
.history-item {
padding: 5px;
border-bottom: 1px solid #eee;
text-align: left;
}
.history-item:last-child {
border-bottom: none;
}
#connectionStatus {
margin-top: 10px;
padding: 5px;
border-radius: 5px;
font-weight: bold;
}
.connected {
background-color: #4CAF50;
color: white;
}
.disconnected {
background-color: #f44336;
color: white;
}
#boardStatusContainer {
margin-top: 10px;
}
.status-box {
margin: 5px 0;
padding: 5px;
border-radius: 5px;
font-weight: bold;
}
.status-connected {
background-color: #4CAF50;
color: white;
}
.status-disconnected {
background-color: #f44336;
color: white;
}
</style>
</head>
<body>
<div class="container">
<h1>Message via MQTT</h1>
<div id="connectionStatus" class="disconnected">Disconnected</div>

<div id="boardStatusContainer">
  <div id="boardWiFiStatus" class="status-box status-disconnected">Device WiFi Disconnected</div>
  <div id="boardMQTTStatus" class="status-box status-disconnected">Device MQTT Disconnected</div>
</div>

<form id="mqttForm">
  <label for="message">Enter Message:</label>
  <input type="text" id="message" name="message" required />
  <button type="submit" id="sendButton">Send Message</button>
</form>

<button id="clearButton">CLEAR HISTORY</button>

<div id="messageHistory">
  <h3>Message History</h3>
</div>

<h2>Sensor Data</h2>
<table>
  <tr>
    <th>Temperature (°C)</th>
    <th>Pressure (hPa)</th>
    <th>Altitude (m)</th>
    <th>Weather</th>
  </tr>
  <tr>
    <td id="temp">--</td>
    <td id="pressure">--</td>
    <td id="altitude">--</td>
    <td id="weather">--</td>
  </tr>
</table>
</div>

<button id="logoutButton" class="logout-btn">Logout</button>

<script>
const firebaseConfig = {
apiKey: "AIzaSyAlzO4KX4TiF3sT9OdwC4iO1XyNlqMEJKA",
authDomain: "https://www.google.com/search?q=notice-board-a831b.firebaseapp.com",
projectId: "notice-board-a831b",
storageBucket: "https://www.google.com/search?q=notice-board-a831b.appspot.com",
messagingSenderId: "879522552762",
appId: "1:879522552762:web:89f0f4811411582c0f9b83",
measurementId: "G-VRPVZK06P1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();
const historyRef = database.ref('message_history/ece/diFJBNOUIFOVSKJIGWIGJ');

auth.onAuthStateChanged((user) =&gt; {
  if (user) {
    setupAllBrokers();
    loadAndDisplayHistory();
  } else {
    window.location.href = &#39;index.html&#39;;
  }
});

const brokerConfigs = {
  &quot;Mosquitto&quot;: { name: &quot;Mosquitto&quot;, wsUrl: &quot;wss://test.mosquitto.org:8081/mqtt&quot; },
  &quot;HiveMQ&quot;: { name: &quot;HiveMQ&quot;, wsUrl: &quot;wss://[broker.hivemq.com:8884/mqtt](https://broker.hivemq.com:8884/mqtt)&quot; }
};

let clients = {};
let currentActiveBroker = null;
let lastSensorMessageTime = Date.now();
const SENSOR_TIMEOUT_MS = 20000;

function updateConnectionStatus(connected) {
  const statusElement = document.getElementById(&#39;connectionStatus&#39;);
  statusElement.textContent = connected ? &quot;App Connected to MQTT&quot; : &quot;Disconnected&quot;;
  statusElement.className = connected ? &#39;connected&#39; : &#39;disconnected&#39;;
}

function getActiveClient() {
  return currentActiveBroker ? clients[currentActiveBroker] : null;
}

// *** MODIFIED: This function loads the FULL history and scrolls to the bottom ***
function loadAndDisplayHistory() {
  historyRef.on(&#39;value&#39;, (snapshot) =&gt; {
    const historyDiv = document.getElementById(&quot;messageHistory&quot;);
    const historyTitle = historyDiv.querySelector(&#39;h3&#39;);
    
    historyDiv.innerHTML = &#39;&#39;;
    historyDiv.appendChild(historyTitle);

    if (snapshot.exists()) {
      const messages = snapshot.val();
      for (const key in messages) {
        const message = messages[key];
        const item = document.createElement(&quot;div&quot;);
        item.className = &quot;history-item&quot;;
        item.innerText = message.text;
        historyDiv.appendChild(item);
      }
    } else {
      const item = document.createElement(&quot;div&quot;);
      item.className = &quot;history-item&quot;;
      item.style.fontStyle = &quot;italic&quot;;
      item.innerText = &quot;No messages yet.&quot;;
      historyDiv.appendChild(item);
    }

    // This line automatically scrolls the list to the bottom to show the last message
    historyDiv.scrollTop = historyDiv.scrollHeight;
  });
}

function setupAllBrokers() {
  Object.entries(brokerConfigs).forEach(([brokerName, config]) =&gt; {
    const client = mqtt.connect(config.wsUrl, {
      clientId: brokerName + &quot;_&quot; + Math.random().toString(16).substr(2, 8),
      clean: true,
      reconnectPeriod: 1000,
    });
    clients[brokerName] = client;
    client.on(&quot;connect&quot;, () =&gt; client.subscribe(&quot;ece/sensorDataujndubd&quot;));
    client.on(&quot;message&quot;, (topic, message) =&gt; {
      if (topic === &quot;ece/sensorDataujndubd&quot;) {
        lastSensorMessageTime = Date.now();
        currentActiveBroker = brokerName;
        const parts = message.toString().split(&quot;|&quot;).map(p =&gt; p.trim());
        document.getElementById(&quot;temp&quot;).innerText = `${parseFloat(parts[0]?.split(&quot;:&quot;)[1]).toFixed(1)} °C`;
        document.getElementById(&quot;pressure&quot;).innerText = `${parseFloat(parts[1]?.split(&quot;:&quot;)[1]).toFixed(1)} hPa`;
        document.getElementById(&quot;altitude&quot;).innerText = `${parseFloat(parts[2]?.split(&quot;:&quot;)[1]).toFixed(1)} m`;
        document.getElementById(&quot;weather&quot;).innerText = parts[3] || &quot;--&quot;;
        const wifiBox = document.getElementById(&quot;boardWiFiStatus&quot;);
        const mqttBox = document.getElementById(&quot;boardMQTTStatus&quot;);
        const wifiStatus = parts[4]?.includes(&quot;Connected&quot;);
        const mqttStatus = parts[5]?.includes(&quot;Connected&quot;);
        wifiBox.textContent = wifiStatus ? &quot;Device WiFi Connected&quot; : &quot;Device WiFi Disconnected&quot;;
        wifiBox.className = wifiStatus ? &quot;status-box status-connected&quot; : &quot;status-box status-disconnected&quot;;
        mqttBox.textContent = mqttStatus ? &quot;Device MQTT Connected&quot; : &quot;Device MQTT Disconnected&quot;;
        mqttBox.className = mqttStatus ? &quot;status-box status-connected&quot; : &quot;status-box status-disconnected&quot;;
        updateConnectionStatus(true);
      }
    });
    client.on(&quot;close&quot;, () =&gt; updateConnectionStatus(false));
  });
}

setInterval(() =&gt; {
  if (Date.now() - lastSensorMessageTime &gt; SENSOR_TIMEOUT_MS) {
    document.getElementById(&quot;boardWiFiStatus&quot;).className = &quot;status-box status-disconnected&quot;;
    document.getElementById(&quot;boardMQTTStatus&quot;).className = &quot;status-box status-disconnected&quot;;
    updateConnectionStatus(false);
    currentActiveBroker = null;
  }
}, 5000);

document.getElementById(&#39;mqttForm&#39;).addEventListener(&#39;submit&#39;, function (e) {
  e.preventDefault();
  const messageText = document.getElementById(&#39;message&#39;).value.trim();
  const activeClient = getActiveClient();
  if (messageText &amp;&amp; activeClient &amp;&amp; activeClient.connected) {
    activeClient.publish(&quot;ece/diFJBNOUIFOVSKJIGWIGJ&quot;, messageText);
    const messageData = {
      text: messageText,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    historyRef.push(messageData);
    document.getElementById(&#39;message&#39;).value = &quot;&quot;;
  } else {
    alert(&quot;Not connected to any MQTT broker or message is empty.&quot;);
  }
});

document.getElementById(&#39;clearButton&#39;).addEventListener(&#39;click&#39;, () =&gt; {
  if (confirm(&quot;Are you sure you want to permanently delete the entire message history for everyone?&quot;)) {
    historyRef.remove();
  }
});

document.getElementById(&#39;logoutButton&#39;).addEventListener(&#39;click&#39;, () =&gt; {
  auth.signOut();
});
</script>

</body>
</html>
